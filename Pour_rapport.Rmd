---
title: "Donnees AMR"
author: "Valentine BERTHIER"
date: "2024-01-14"
output: html_document
bibliography : projet-stat-2A.bib
---

```{r setup,echo=FALSE,include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(tidyr)
library(dplyr)
library(ggplot2)
library(stringr)
```

Essayons de mettre en forme ce fichier avec chaque analyse que nous trouvons vraiment indispensable. Il faudrait que ce fichier ne contienne que les graphiques permettant la validation de l'indicateur.

# INTRODUCTION

## Importation des données

```{r,echo=FALSE}
AMR <- read_excel("donnees/donnees_AMR.xlsx")

# Données permettant d'étudier la perte d'effectif des pan-sensibles
ResapathFrance <- read_xlsx("donnees/ModeleCollecte_PROMISE_ResapathFrance.xlsx",sheet = "Modele de collecte")

# On renomme "bovin-abattoir" en "veau-abattoir"
AMR$population <- ifelse(AMR$population == "bovin-abattoir", "veau-abattoir", AMR$population)
```

## Transformation des jeux de donées

```{r,echo=FALSE}
AMR_nationale <- AMR %>%
  filter(region == "Nationale")
AMR_regionale <- AMR %>%
  filter(region != "Nationale")

AMR_nationale_animal <- AMR_nationale %>%
  filter(famille == "animale")
AMR_nationale_humain <- AMR_nationale %>%
  filter(famille == "humaine")

# Indicatrice selon que la population provient d'un abattoir ou non
AMR_nationale_animal$abattoir <- grepl("abattoir", AMR_nationale_animal$population, ignore.case = TRUE)

AMR_regionale$famille2 <- paste(AMR_regionale$famille, ifelse(grepl("abattoir", AMR_regionale$population, ignore.case = TRUE), "-abattoir", ""), sep = "")

# Uniformisation entre les différentes tables
ResapathFrance <- ResapathFrance%>%
  mutate(population = as.factor(population),
         `profil AMR`= as.factor(`profil AMR`),
         region = as.factor(region))

# On retire les observations SARM (ça supprime aussi les lignes vide)
ResapathFrance_sansSARM <- ResapathFrance%>%
  filter(`profil AMR` != "SARM", bacterie == "Escherichia coli")
```

## Anlayse descriptive

Nous recherchons une liaison entre une variable qualitative (la population) et une variable quantitative (la valeur AMR). Pour cela, un boxplot permet d'avoir un premier aperçu des ressemblances.

```{r,echo=FALSE}
label <- c("Veau", "Lapin", "Poulet", "Porc", "Volaille", "Dinde", "Caprin", "EHPAD", "Veau", "ES-hemoculture", "Ovin", "ES", "Porc", "Ville", "Cheval","Volaille", "Chien", "Bovin", "Chat")

ggplot(AMR_regionale, aes(x = `valeur AMR`, y = reorder(population, `valeur AMR`, mean), fill = famille2))+
  geom_boxplot()+
  labs(title = "Des résultats dispersés pour toutes les populations",
       subtitle = "Comparaison des valeurs AMR entre animaux et humains",
       #subtitle = "Comparaison des valeurs Pan-S entre animaux et humains",
       caption = "Note: Chaque ligne de données correspond à une région et une année",
       y = NULL,
       x = "AMR moyen",
       x = "Valeur Pan-S",
       fill = "Famille")+
  theme_minimal()+
  scale_fill_manual(values = c("#90fc9b", "#4b9c4f", "#fa9c43"))+
  scale_y_discrete(labels = label)
```
Sur ce graphique nous avons ajouté la répartition des familles qui permet d'avoir un premier aperçu sur les valeurs AMR humaines par rapport à animales.

Nous pouvons observer que les animaux "domestiques" (Chien, chat, cheval) ont une plus grande sensibilité que les animaux dits de "production" (volaille-abattoir, bovin-abattoir, poulet-abattoir) qui ont tendance à plus apparaître vers les faibles valeurs de sensibilité.

# Famille animale

```{r,echo=FALSE}
moyenne_AMR <- AMR_nationale_animal %>%
  group_by(population, famille, abattoir) %>%
  summarize(moyenne_AMR = mean(`valeur AMR`)) %>%
  arrange(moyenne_AMR)

ggplot(moyenne_AMR, aes(x = moyenne_AMR, y = reorder(population, moyenne_AMR), fill = abattoir))+
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Les animaux d'abattoir sont plus résistants aux antibiotiques",
       subtitle = "L'antibiorésistance (AMR) des différentes populations animales",
       caption = "Note: Moyenne calculée sur les années des données nationales.",
       y = "Population",
       x = "AMR moyen") +
  theme_minimal()  +
  guides(fill = FALSE) +
  scale_fill_manual(values = c("lightblue", "lightgreen"))

moyenne_AMR <- AMR_nationale_humain %>%
  group_by(population, famille) %>%
  summarize(moyenne_AMR = mean(`valeur AMR`)) %>%
  arrange(moyenne_AMR)

ggplot(moyenne_AMR, aes(x = moyenne_AMR, y = reorder(population, moyenne_AMR)))+
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "En ville, les individus sont moins résistants aux antibiotiques",
       subtitle = "L'antibiorésistance (AMR) des différentes populations humaines",
       caption = "Note: Moyenne calculée sur les années des données nationales.",
       y = "Population",
       x = "AMR moyen") +
  theme_minimal()
```

```{r,echo=FALSE}
ggplot(AMR_nationale_animal[which(AMR_nationale_animal$abattoir == TRUE),], aes(x = annee, y = `valeur AMR`, group = population, color = population)) +
  geom_line(stat = "summary", fun = "mean") +
  geom_point(stat = "summary", fun = "mean", size = 2) +
  labs(title = "Hausse générale de la sensibilité des populations en abattoir",
       subtitle = "Évolution des moyennes de l'AMR",
       x = NULL,
       y = "AMR moyen",
       color = "Population") +
  theme_minimal()

ggplot(AMR_nationale_animal[which(AMR_nationale_animal$abattoir == TRUE),], aes(x = annee, y = `effectif AMR`, group = population, color = population)) +
  geom_line(stat = "summary", fun = "mean") +
  geom_point(stat = "summary", fun = "mean", size = 2) +
  labs(title = "Hausse générale de la sensibilité des populations en abattoir",
       subtitle = "Évolution des moyennes de l'AMR",
       x = NULL,
       y = "AMR moyen",
       color = "Population") +
  theme_minimal()

ggplot(AMR_nationale_animal[which(AMR_nationale_animal$abattoir == FALSE),], aes(x = annee, y = `valeur AMR`, group = population, color = population)) +
  geom_line(stat = "summary", fun = "mean") +
  geom_point(stat = "summary", fun = "mean", size = 2) +
  labs(title = "Baisse de la sensibilité aux antibiotiques des animaux domestiques",
       subtitle = "Évolution des moyennes de l'AMR",
       x = NULL,
       y = "AMR moyen",
       color = "Population") +
  theme_minimal()
```
\newline
## 2 dimension d'étude : Nationale ou Régionale. Laquelle choisir pour quelle famille ? 
### Famille : Animale
```{r, echo=FALSE, include=FALSE}
# Effectif totaux étudiés pour chaque année et chaque population indépendamment de la région
df_region <- AMR %>% 
  select(annee,population,region,famille,`effectif AMR`)%>%
  filter(region!="Nationale")%>%
  group_by(annee,population,famille) %>%
  summarise(effectif_total_region = sum(`effectif AMR`))

df_region

# Essayons de contraster cela aux effectifs nationaux
df_national<-AMR %>%
  select(annee,population,famille,region,`effectif AMR`)%>%
  filter(region=="Nationale")%>%
  group_by(annee,population,famille) %>%
  summarise(effectif_total_national = sum(`effectif AMR`))

df_national

# Joindre les tables en utilisant la fonction dplyr inner_join()
effectifs_totaux <- inner_join(df_region,df_national,by = c("annee","population","famille"))
effectifs_totaux<-effectifs_totaux%>%
mutate(diff_effectif=effectif_total_national-effectif_total_region)
# En supposant que les effectifs nationaux sont plus grand que ceux régionaux car on comptabiliserait les régions pour lesquelles nous n'étudions pas assez d'individus
effectifs_totaux

```

```{r,echo=FALSE}
effectifs_totaux_animale<-effectifs_totaux%>%
  filter(famille==unique(AMR$famille)[1])

ggplot(data=effectifs_totaux_animale, aes(x = annee, y = effectif_total_national)) +
  geom_col(width = 1, fill = "orange") +       # tracer le nombre de cas sous forme de colonnes
  theme_minimal()+                              # simplifier les  arrière-plans
  labs(                                         # ajouter  les noms d'axes, titres ... 
    x = "Année d'étude",
    y = "Effectif AMR étudié",
    title = "Effectif total AMR par population animale en fonction de l'année") +
  facet_wrap(~population) 
  
```

```{r,echo=FALSE}
effectifs_totaux_animale<-effectifs_totaux_animale%>%
  mutate(taux_eff_perte=(diff_effectif/effectif_total_national)*100)


boxplot_taux<-ggplot(effectifs_totaux_animale, aes(x = reorder(population, taux_eff_perte), y = taux_eff_perte)) +
  geom_boxplot() +
  labs(title = "% de perte d'effectif lors du passage de l'étude Nationale à Régionale",
       x = "Groupe",
       y = "taux d'effectif perdu",
       caption = str_glue("Cohorte : population humaine au niveau National\nLecture : On observe des pertes non négligeables pour toutes les populations lors du passage de l'étude\nNationale à régionale. On en conclut que beaucoup de régions n'ont pas les effectifs nécessaires pour\ns'inscrire dans les rapports (minimum 30)"))+
  scale_y_continuous(labels =scales::number_format(suffix=" %"),limits=c(0,100))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
        
boxplot_taux
```
Pour les populations animales, la perte est assez élevée donc une étude régionale constitue un risque de perte d'informations. 

### Famille : Humaine


```{r, echo=FALSE}
effectifs_totaux_humain<-effectifs_totaux%>%
  filter(famille==unique(AMR$famille)[2])

ggplot(data=effectifs_totaux_humain, aes(x = annee, y = effectif_total_national)) +
  geom_col(width = 1, fill = "skyblue") +       # tracer le nombre de cas sous forme de colonnes
  theme_minimal()+                              # simplifier les  arrière-plans
  labs(                                         # ajouter  les noms d'axes, titres ... 
    x = "Année d'étude",
    y = "Effectif AMR étudié",
    title = "Effectif total AMR par population humaine en fonction de l'année") +
  facet_wrap(~population) 

```

```{r,echo=FALSE}
#barplot(population ~ effectif_total_region, data = effectifs_totaux)
# ça ne marche pas car on observe plusieurs fois chaque population

effectifs_totaux_humain<-effectifs_totaux_humain%>%
  mutate(taux_eff_perte=(diff_effectif/effectif_total_national)*100)%>%
  group_by(annee,population)


boxplot_taux<-ggplot(effectifs_totaux_humain, aes(x = reorder(population, taux_eff_perte), y = taux_eff_perte)) +
  geom_boxplot() +
  labs(title = "% de perte d'effectif lors du passage de l'étude Nationale à Régionale",
       x = "Population étudiée",
       y = "taux d'effectif perdu",
       caption = str_glue("Cohorte : population humaine au niveau National\nLecture : Pour chaque population, on observe une perte d'effectif de moins d'1%"))+
  scale_y_continuous(labels =scales::number_format(suffix=" %"),limits=c(0,1))
boxplot_taux

```

La différence entre les effectifs nationaux et régionaux pour les population humaines sont de l'ordre de 1% et constitue donc une part négligeable à l'étude. L'étude au niveau régionale ne constitue donc pas un risque en terme de perte d'information. 



# VALIDATION DE L'INDICATEUR

## Est-il possible de calculer l'indicateur pour toutes les caractéristiques ?

## L'indicateur est-il basé sur un nombre d'isolats plus faible (significativement ?) que d'autres indicateurs de résistance ?

```{r,echo=FALSE}
table1 <- ResapathFrance_sansSARM %>%
  filter(`profil AMR` == "pan-sensible") %>%
  mutate(eff_pansensible = `effectif AMR`) %>%
  select(annee, population, eff_pansensible)

table2 <- ResapathFrance_sansSARM %>%
  filter(`profil AMR` == "C3G-R") %>%
  mutate(eff_C3G = `effectif AMR`) %>%
  select(annee, population, eff_C3G)

table_join <- merge(table1, table2, by = c("annee", "population"), all = TRUE)

for (pop in levels(table_join$population)){
  table_join1 <- table_join %>%
    filter(population == pop) %>%
    mutate(taux_eff = round((eff_pansensible * 100) / eff_C3G, 2),
           min_max_value = ifelse(taux_eff == max(taux_eff), "MAX", ifelse(taux_eff == min(taux_eff), "MIN", "none")))
  
  moyenne = round(mean(table_join1$taux_eff),2)
  
  plot <- ggplot(data = table_join1, aes(x = annee, y = taux_eff, fill = min_max_value))+
    geom_col(width = 0.5) + 
    theme_minimal()+                     
    labs(x = "Annee",
         y = "",
         title = "Fraction d'isolats bactériens pour lesquels la pan-sensibilité a pu être calculée.",
         subtitle = str_glue("En moyenne, le taux est de {moyenne}")) +
    facet_wrap(~population)+
    scale_y_continuous(labels = scales::number_format(suffix="%"), limits = c(0,100))+
    scale_fill_manual(values = c("MIN" = "red", "MAX" = "green","none" = "grey"), guide = "none")
  plot(plot)
}
```
\newline Hormis pour le bovin-abattoir à l'année 2019, dans ce cas le profil FQ-R semble être plus sensible que les autres (effectif plus grand), aucun antibiotique ne semble présenter une résistance plus forte ce qui aurait engendrer une grosse différence dans les effectifs. 
Il n'y a donc pas de grande perte d'effectif suite aux AB testés. 

<<<<<<< HEAD

```{r,echo=FALSE}


table_join<-table_join%>%
  mutate(taux=(eff_pansensible/eff_C3G)*100)

# Boxplot pour représenter la variation intra-groupe


ggplot(table_join, aes(x = reorder(population, taux), y = taux)) +
  geom_boxplot() +
  labs(title = "Variation de la fraction d'isolats bactériens pour lesquels la pan-sensibilité a pu \nêtre calculée au sein de chaque groupe étudié.",
       x = "Groupe",
       y = "taux de représentation",
       caption = str_glue("Cohorte : population animale au niveau National\nLecture : On remarque un taux de calcul plus faible pour les population lapin, Dinde et Poule-poulet"))+
  scale_y_continuous(labels =scales::number_format(suffix=" %"),limits=c(0,100))
```


## Les situations et les variables disponibles sont assez contrastées ?


## L'indicateur est-il lié à l'exposition aux antimicrobiens (= la pression sélective) ?




## Cartographie

## Données AMR pour la population ville de 2021

## Données AMR pour la population bovin de 2021
## Données AMR pour la population chien&chat de 2021






