---
title: "Donnees AMR"
author: "Valentine BERTHIER"
date: "2024-01-14"
output: html_document
bibliography : projet-stat-2A.bib
---

```{r setup,echo=FALSE,include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(tidyr)
library(dplyr)
library(ggplot2)
library(stringr)
```

Essayons de mettre en forme ce fichier avec chaque analyse que nous trouvons vraiment indispensable. Il faudrait que ce fichier ne contienne que les graphiques permettant la validation de l'indicateur.

# INTRODUCTION DE LA PARTIE ANALYSE

## Importation des données et transformation des variables

```{r,echo=FALSE, include=FALSE}
AMR <- read_excel("donnees/donnees_AMR.xlsx")

# Données permettant d'étudier la perte d'effectif des pan-sensibles
ResapathFrance <- read_xlsx("donnees/ModeleCollecte_PROMISE_ResapathFrance.xlsx",sheet = "Modele de collecte")

# Données d'usage d'antibiotiques
usage_animal <- read_excel("donnees/D_animale_nationale_avec_alea_corrige.xlsx", range = "B1:G61") # range permet de ne pas prendre en compte la première ligne qui contient les identifiants

usage_animal$population <- as.factor(usage_animal$population)

usage_animal <- usage_animal %>%
  arrange(population, -annee)

# On renomme "bovin-abattoir" en "veau-abattoir"
AMR$population <- ifelse(AMR$population == "bovin-abattoir", "veau-abattoir", AMR$population)

AMR_nationale <- AMR %>%
  filter(region == "Nationale")
AMR_regionale <- AMR %>%
  filter(region != "Nationale")

AMR_nationale_animal <- AMR_nationale %>%
  filter(famille == "animale")
AMR_nationale_humain <- AMR_nationale %>%
  filter(famille == "humaine")

# Indicatrice selon que la population provient d'un abattoir ou non
AMR_nationale_animal$abattoir <- grepl("abattoir", AMR_nationale_animal$population, ignore.case = TRUE)

AMR$famille2 <- paste(AMR$famille, ifelse(grepl("abattoir", AMR$population, ignore.case = TRUE), "-abattoir", ""), sep = "")

AMR_regionale$famille2 <- paste(AMR_regionale$famille, ifelse(grepl("abattoir", AMR_regionale$population, ignore.case = TRUE), "-abattoir", ""), sep = "")

# Uniformisation entre les différentes tables
ResapathFrance <- ResapathFrance%>%
  mutate(population = as.factor(population),
         `profil AMR`= as.factor(`profil AMR`),
         region = as.factor(region))

# On retire les observations SARM (ça supprime aussi les lignes vide)
ResapathFrance_sansSARM <- ResapathFrance%>%
  filter(`profil AMR` != "SARM", bacterie == "Escherichia coli")
```

## Anlayse descriptive

Nous recherchons une liaison entre une variable qualitative (la population) et une variable quantitative (la valeur AMR). Pour cela, un boxplot permet d'avoir un premier aperçu des ressemblances.

```{r,echo=FALSE}
label <- c("Veau", "Lapin", "Poulet", "Porc", "Volaille", "Dinde", "Caprin", "EHPAD", "Veau", "ES-hemoculture", "Ovin", "ES", "Porc", "Ville", "Cheval","Volaille", "Chien", "Bovin", "Chat")

ggplot(AMR_regionale, aes(x = `valeur AMR`, y = reorder(population, `valeur AMR`, mean), fill = famille2))+
  geom_boxplot()+
  labs(title = "Des résultats dispersés pour toutes les populations",
       subtitle = "Comparaison des valeurs Pan-S entre animaux et humains",
       caption = "Note: Chaque ligne de données correspond à une région et une année",
       y = NULL,
       x = "AMR moyen",
       x = "Valeur Pan-S",
       fill = "Famille")+
  theme_minimal()+
  scale_fill_manual(values = c("#90fc9b", "#4b9c4f", "#fa9c43"))+
  scale_y_discrete(labels = label)

label <- c("Veau", "Lapin", "Porc", "Poulet", "Volaille", "Dinde", "Caprin", "EHPAD", "Veau", "ES-hemoculture", "Ovin", "ES", "Porc","Dinde", "Ville", "Cheval", "Volaille", "Chien", "Poulet", "Bovin", "Chat")

ggplot(AMR, aes(x = `valeur AMR`, y = reorder(population, `valeur AMR`, mean), fill = famille2))+
  geom_boxplot()+
  labs(title = "Des résultats dispersés pour toutes les populations",
       subtitle = "Comparaison des valeurs Pan-S entre animaux et humains (France entière ajoutée)",
       caption = "Note: Chaque ligne de données correspond à une région ou la france entière et une année",
       y = NULL,
       x = "Valeur Pan-S",
       fill = "Famille")+
  theme_minimal()+
  scale_fill_manual(values = c("#90fc9b", "#4b9c4f", "#fa9c43"))+
  scale_y_discrete(labels = label)
```
Sur ce graphique nous avons ajouté la répartition des familles qui permet d'avoir un premier aperçu sur les valeurs AMR humaines par rapport à animales.

Nous pouvons observer que les animaux "domestiques" (Chien, chat, cheval) ont une plus grande sensibilité que les animaux dits de "production" (volaille-abattoir, bovin-abattoir, poulet-abattoir) qui ont tendance à plus apparaître vers les faibles valeurs de sensibilité.

# VALIDATION DE LA PAN-S

## Propriétés de l'indicateur

### Possibilité de calcul de la pan-S

Taille du jeu de données (nombre moyen d’isolats considérés)
Il s’agit ici de montrer que la proportion de pan-sensibles est calculable pour toutes les populations. Et que la perte d’information liée aux souches pour lesquelles ce n’est pas calculable est restreinte. -> présentation d’un boxplot des taux de calcul par espèce/population 

#### Taille du jeu de données
```{r echo=TRUE}
print(paste("nombre moyen d'isolats considérés en France entière: ", round(mean(AMR_nationale$`effectif AMR`), 0)))
print(paste("nombre moyen d'isolats considérés en découpage par région: ", round(mean(AMR_regionale$`effectif AMR`), 0)))

AMR %>%
  group_by(population, annee, region) %>%
  summarise(`nombre moyen d'isolats` = round(mean(`effectif AMR`), 0))%>%
  arrange(desc(`nombre moyen d'isolats`))

AMR %>%
  group_by(population) %>%
  summarise(`nombre de régions` = n_distinct(region)-1)%>%
  arrange(desc(`nombre de régions`))
```

Par population et année, il y a, en moyenne, 24331 isolats. Plus on avance dans le temps, plus on a d'isolats considérés dans les analyses.

```{r,echo=FALSE}
effectif_national <- AMR %>%
  filter(region == "Nationale") %>%
  select(annee, population, `effectif AMR`) %>%
  summarise(effectif_national = sum(`effectif AMR`), .by = c(annee, population))

effectif_regional <- AMR %>%
  filter(region != "Nationale") %>%
  select(annee, population, `effectif AMR`) %>%
  summarise(effectif_regional = sum(`effectif AMR`), .by = c(annee, population))

AMR_perte_regionale <- full_join(effectif_national, effectif_regional)

AMR_perte_regionale_animal <- AMR_perte_regionale %>%
  mutate(perte = 1 - effectif_regional/effectif_national) %>%
  filter(!is.na(perte))%>%
  filter(!(population %in% c("ville", "EHPAD", "ES", "ES-hemoculture")))

AMR_perte_regionale_humain <- AMR_perte_regionale %>%
  mutate(perte = 1 - effectif_regional/effectif_national) %>%
  filter(!is.na(perte))%>%
  filter(population %in% c("ville", "EHPAD", "ES", "ES-hemoculture"))

rm(AMR_perte_regionale, effectif_regional, effectif_national)
  
label <- c("Chien", "Veau", "Chat", "Bovin", "Cheval", "Volaille-abattoir", "Dinde-abattoir", "Lapin", "Porc", "Porc-abattoir", "Poulet-abattoir", "Veau-abattoir")

ggplot(AMR_perte_regionale_animal, aes(x = reorder(population, perte), y = perte)) +
  geom_boxplot() +
  geom_hline(yintercept = mean(AMR_perte_regionale_animal$perte), color = "darkgreen", size = 0.8, linetype = "dashed") +
  labs(title = "Perte d'effectif lors du passage de l'échelle nationale à régionale",
       x = NULL,
       y = "Taux d'effectif perdu",
       caption = str_glue("Cohorte : population animale\nLecture : Entre 2012 et 2021, 50% des années ont fait face à une perte régionale d'au moins 50% pour la population des porcs."))+
  scale_y_continuous(labels = scales::label_percent(scale = 100))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  annotate("text", x = 11, y = 0.18, label = "Mean = 23.54%", colour = "darkgreen", size = 3.3)+
  scale_x_discrete(labels = label)

ggplot(AMR_perte_regionale_humain, aes(x = reorder(population, perte), y = perte)) +
  geom_hline(yintercept = mean(AMR_perte_regionale_humain$perte), color = "darkgreen", size = 0.8, linetype = "dashed") +
  geom_boxplot() +
  labs(title = "Perte d'effectif lors du passage de l'échelle nationale à régionale",
       x = NULL,
       y = "Taux d'effectif perdu",
       caption = str_glue("Cohorte : population humaine\nLecture : Entre 2012 et 2021, les isolats humains ont subi moins de 1% de perte au niveau régional."))+
  scale_y_continuous(labels = scales::label_percent(scale = 100), limits = c(0,0.01))+
  annotate("text", x = 0.7, y = 0.0014, label = "Mean = 0.09%", colour = "darkgreen", size = 3.3)+
  scale_x_discrete(labels = c("ES", "ES-hemoculture", "Ville", "EHPAD"))
```
La différence entre les effectifs nationaux et régionaux pour les population humaines sont de l'ordre de 1% et constitue donc une part négligeable à l'étude. L'étude au niveau régionale ne constitue donc pas un risque en terme de perte d'information. Pour les populations animales, la perte est assez élevée donc une étude régionale constitue un risque de perte d'informations. 

#### Perte d’information liée aux souches pour lesquelles ce n’est pas calculable

```{r,echo=FALSE}
table1 <- ResapathFrance_sansSARM %>%
  filter(`profil AMR` == "pan-sensible") %>%
  mutate(eff_pansensible = `effectif AMR`) %>%
  select(annee, population, eff_pansensible)

table2 <- ResapathFrance_sansSARM %>%
  filter(`profil AMR` == "C3G-R") %>%
  mutate(eff_C3G = `effectif AMR`) %>%
  select(annee, population, eff_C3G)

table_join <- merge(table1, table2, by = c("annee", "population"), all = TRUE)

table_join<-table_join%>%
  mutate(taux=(eff_pansensible/eff_C3G)*100)

label <- c("Veau", "Chat", "Chien", "Cheval", "Bovin", "Porc", "Poulet", "Dinde", "Lapin")

ggplot(table_join, aes(x = reorder(population, -taux), y = 100-taux)) +
  geom_boxplot() +
  geom_hline(yintercept = 100 - mean(table_join$taux), color = "darkgreen", linetype = "dashed", size = 0.8) +
  labs(title = "Variation de la fraction d'isolats bactériens pour lesquels la pan-sensibilité n'a pas\npu être calculée au sein de chaque population étudiée",
       x = NULL,
       y = "Taux de perte",
       caption = str_glue("Cohorte : population animale au niveau national\nLecture : En moyenne, 13 % des animaux étudiés n'ontp pas un profil de résistance pan-sensible."))+
  scale_y_continuous(labels =scales::number_format(suffix=" %"),limits=c(0,100))+
  scale_x_discrete(labels = label)+
  annotate("text", x = 1.5, y = 18.5, label = "Mean = 13.2%", colour = "darkgreen", size = 3.3)
```

### Validité de l'information

Comparer ici les valeurs pan-S si on rajoute les tetracyclines chez animal ou colistine ou carbapenemes chez homme ->est-ce que valeur change beaucoup. Pas faisable pour toutes sources de données mais ok pour Resapath et LNR chez l’animal.

### Variabilité des données

représenter des boxplots par population des estimations régionales annuelles (ou toute autre représentation type violinplot, raincloud plot ou autre). -> pour montrer que de la variabilité.
Représenter des cartes (dernière année par exemple pour homme et/ou carnivores ou bovins) pour illustrer variabilité géographique.
Faire une estimation des facteurs de variation (entre année, région, population). (analyse de variance)

La variabilité entre les populations a déjà pu être observée dans l'analyse descriptive, observons dans cette partie, uniquement les tendances régionales et annuelles.

#### Variabilité annuelle

#### Variabilité entre les régions

Cartographie

#### L'analyse de variance

## Points d'intérêt de l'indicateur

### Identification de tendances

Spageti plot et tests de tendance -> pour montrer que des tendances identifiables

```{r,echo=FALSE}
ggplot(AMR_nationale_animal[which(AMR_nationale_animal$abattoir == TRUE),], aes(x = annee, y = `valeur AMR`, group = population, color = population)) +
  geom_line(stat = "summary", fun = "mean") +
  geom_point(stat = "summary", fun = "mean", size = 2) +
  labs(title = "Hausse générale de la sensibilité des populations en abattoir",
       subtitle = "Évolution des moyennes de l'AMR",
       x = NULL,
       y = "AMR moyen",
       color = "Population") +
  theme_minimal()

ggplot(AMR_nationale_animal[which(AMR_nationale_animal$abattoir == TRUE),], aes(x = annee, y = `effectif AMR`, group = population, color = population)) +
  geom_line(stat = "summary", fun = "mean") +
  geom_point(stat = "summary", fun = "mean", size = 2) +
  labs(title = "Hausse générale de la sensibilité des populations en abattoir",
       subtitle = "Évolution des moyennes de l'AMR",
       x = NULL,
       y = "AMR moyen",
       color = "Population") +
  theme_minimal()

ggplot(AMR_nationale_animal[which(AMR_nationale_animal$abattoir == FALSE),], aes(x = annee, y = `valeur AMR`, group = population, color = population)) +
  geom_line(stat = "summary", fun = "mean") +
  geom_point(stat = "summary", fun = "mean", size = 2) +
  labs(title = "Baisse de la sensibilité aux antibiotiques des animaux domestiques",
       subtitle = "Évolution des moyennes de l'AMR",
       x = NULL,
       y = "AMR moyen",
       color = "Population") +
  theme_minimal()
```
#### Tests de tendance

```{r}
############### COCHRAN ARMITAGE
# Chargement des bibliothèques
library(dplyr)
library(DescTools)

# Définir la fonction pour effectuer le test pour une modalité donnée
perform_CochranArmitageTest <- function(data, population_modalite) {
  # Filtrer les données pour la modalité spécifiée
  matrice <- data %>% filter(population == population_modalite)
  
  # Calculer les valeurs Pan-sensible et Non Pan-sensible pour chaque année
  matrice <- matrice %>% mutate(pan_sensible = `valeur AMR` * `effectif AMR` / 100,
                                 non_pan_sensible = `effectif AMR` - pan_sensible)
  
  # Ordonner par année
  matrice <- matrice[order(matrice$annee), ]
  
  # Sélectionner les colonnes pertinentes
  matrice <- matrice[, c("annee", "pan_sensible", "non_pan_sensible")]
  
  # Transposer la matrice et nommer les colonnes avec les années
  matrice <- t(matrice)
  colnames(matrice) <- as.character(matrice[1, ])
  matrice <- matrice[-1, ]
  
  # Convertir les années en numérique
  colnames(matrice) <- as.numeric(colnames(matrice))
  
  # Afficher le résultat du test de Cochran-Armitage
  cat("Résultats pour la modalité", population_modalite, ":\n")
  print(CochranArmitageTest(matrice))
}

# Appliquer la fonction pour chaque modalité de population
modalites_population <- c("ville", "ES-hemoculture", "ES", "EHPAD")
for (modalite in modalites_population) {
  perform_CochranArmitageTest(AMR_humaine_fr, modalite)
}

### pour les animaux :
# Définir les modalités de population pour AMR_animale_fr
modalites_population_animale <- unique(AMR_animale_fr$population)

# Créer une liste pour stocker les résultats des tests
resultats_tests <- list()

# Boucle sur les modalités de population animale
for (modalite in modalites_population_animale) {
  resultats_tests[[modalite]] <- perform_CochranArmitageTest(AMR_animale_fr, modalite)
}
```

### Lien à l'usage

Regression beta ou correlation sur lien entre usage et resistance à echelle nationale dans temps pour chaque population et à échelle régionale pour homme (modèles de panel ?). 
Voir s’il faut tester un décalage dans le temps (lien meilleur si prend usage N-1 ?)
Voir s’il faut tester le lien à l’usage décomposé par famille antibiotique (et non somme globale -> déterminer une famille qui jouerait plus particulièrement)
Significativité attendue et force du lien (part de variabilité expliquée par usage ? aire sous courbe ROC ?).

```{r}

```

