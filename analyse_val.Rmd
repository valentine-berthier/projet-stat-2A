---
title: "analyse_valentine"
author: "Valentine BERTHIER"
date: "2024-01-16"
output: html_document
---

```{r setup, echo=FALSE, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rm(list=ls())
```


# 0. LIBRARIES
```{r librairies, echo=FALSE, include=FALSE}
library(readxl)
library(dplyr)
library(ggplot2)
library(stringr)
library(questionr)
library(tidyverse)

```

#Etude du jeu de données "AMR"
##1. Importation du jeu de données
```{r chargement AMR, echo=FALSE, include=FALSE}
AMR <- read_excel("donnees/donnees_AMR.xlsx", 
col_types = c("text", "numeric", "text", 
"text", "text", "numeric", "numeric"))

```

#2. Quelles sont les variables de ce jeu de données
```{r etude noms , echo=FALSE, include=FALSE}
names(AMR)
```
##3. Y-a-t-il des valeurs manquantes ? 
```{r études valeurs manquantes, echo=FALSE, include=FALSE}
which(is.na(AMR)=="TRUE")
```
Il y n'y a pas de valeurs manquantes

4. Quelles sont les catégories étudiées ? 
`r unique(AMR$famille)`

5. Quelles sont les familles étudiées ? 
`r unique(AMR$population)``

6. Lesquelles sont associées à l'étude des humains ? 
`r unique(AMR$population[which(AMR$famille=="humaine")])`

```{r pop humaine, echo=FALSE, include=FALSE}
#Nous les sauvegardons dans une variable
pop_humaine <- unique(AMR$population[which(AMR$famille=="humaine")])
```

7. 
```{r ?, echo=FALSE, include=FALSE}
annees<-sort(unique(AMR$annee))

AMR%>%
  filter(famille=="humaine")%>%
  select(annee,population,famille,region,'valeur AMR')

donnees_humaines_nationales<-AMR%>%
  filter(famille=="humaine",region=='Nationale')%>%
  select(annee,population,'valeur AMR')%>%
  ggplot(aes(x=annee,y=`valeur AMR`))+ geom_col(aes(fill=population),position="dodge")+labs(title = "Etude de la pan-sensibilité aux antibiotiques sur les populations humaines",caption = "Cohorte : population de catégories humaine au niveau National \n Lecture : Les population en ville présentent une sensibilité plus élévée aux antibiotiques de 2012 à 2021 ")



  
```
7.2 Pour une étude au sein des régions 

```{r étude régionale, echo=FALSE, include=FALSE}

regions<-unique(AMR$region)
famille="humaine"
region="Grand Est"

max_AMR<-AMR%>%
  filter(famille=="humaine",region==region)%>%
  rename(v_AMR=`valeur AMR`)%>%
  select(v_AMR)%>%
  max()

pop_max<-AMR$population[which(AMR$`valeur AMR`==max_AMR)]
annee_max<-AMR$annee[which(AMR$`valeur AMR`==max_AMR)]

plot<-AMR%>%
  filter(famille=="humaine",region==region)%>%
  select(annee,population,'valeur AMR')%>%
  ggplot(aes(x=annee,y=`valeur AMR`))+ geom_col(aes(fill=population),position="dodge")+labs(title =str_glue("Etude de la pan-sensibilité aux antibiotiques sur les populations {famille}"),caption =str_glue("Cohorte : population de catégories humaine au niveau {region} \n","Lecture : Au niveau de : {region}, la population qui présente le plus haut taux de sensibilité aux antibiotiques ({max_AMR}) est :{pop_max} et ceci en {annee_max} "))

plot
```



# Etude des données manquantes

```{r regions manquantes, echo=FALSE, include=FALSE}
# régions étudiées 
unique(AMR$region)

#années étudiées
unique(AMR$annee)
```


```{r, echo=FALSE, include=FALSE}
# régions représentée 
effectif_pop_annee<-table(AMR$annee,AMR$population)

```
Cette table nous montre le nombre de régions représentées (ou Nationale) par années pour chaque population. 

Pour chaque population par année, le nombre maximale d'observation est de `length(unique(AMR$region))`correspondant au nombre de région présentent dans l'étude + l'étude au niveau National. 
On remarque bien que certaines populations ne sont pas, ou très peu étudiées, pour certaines années. 

La dernière ligne du tableau correspond au nombre de population étudiée (toutes régions confondues) par année. On voit bien que le dispositif a beaucoup évolué car en 2012, seulement 65 populations furent étudiées. Ce nombre atteint 152 en 2021. 

```{r étude effectifs, echo=FALSE, include=FALSE}
barplot(effectif_pop_annee,beside=TRUE,legend=rownames(effectif_pop_annee))

legend(x=10,y=10, legend = "Légende personnalisée", fill = "skyblue")

```
On ne voit pas grand chose sur ce graphique mais, on peut se rendre compte que certaines populations de sont pas très bien représentées au niveau régional. 




```{r étude effectif 2, echo=FALSE, include=FALSE}
# Années étudiées
effectif_pop_region<-table(AMR$region,AMR$population)
addmargins(effectif_pop_region)

```
Cette table nous renvoie le nombre d'années d'études (sans savoir lesquelles) des populations par régions

La population la moins étudiée par année est le *porc-abattoir* avec seulement 8 études (régions et années confondues, cela peut être 8 régions sur une même année ou bien 8 années différentes sur des régions différentes ou non) et par région, c'est la Guadeloupe qui est la moins représentée avec seulement 8 populations étudiées (ici seule la famille humaine a été étudiée)



# tableau d'effectif de population étudié (par année et par région)

```{r, echo=FALSE, include=FALSE}
freq_pop<-freq(AMR$population,total=TRUE,valid=FALSE)
#part des populations étudiée effectif=+1 si la population à été étudiée à une année dans une région

```


```{r, echo=FALSE, include=FALSE}
# Effectif totaux étudiés pour chaque année et chaque population indépendamment de la région
df_region <- AMR %>% 
  select(annee,population,region,famille,`effectif AMR`)%>%
  filter(region!="Nationale")%>%
  group_by(annee,population,famille) %>%
  summarise(effectif_total_region = sum(`effectif AMR`))

df_region

# Essayons de contraster cela aux effectifs nationaux
df_national<-AMR %>%
  select(annee,population,famille,region,`effectif AMR`)%>%
  filter(region=="Nationale")%>%
  group_by(annee,population,famille) %>%
  summarise(effectif_total_national = sum(`effectif AMR`))

df_national

# Joindre les tables en utilisant la fonction dplyr inner_join()
effectifs_totaux <- inner_join(df_region,df_national,by = c("annee","population","famille"))
effectifs_totaux<-effectifs_totaux%>%
mutate(diff_effectif=effectif_total_national-effectif_total_region)
# En supposant que les effectifs nationaux sont plus grand que ceux régionaux car on comptabiliserait les régions pour lesquelles nous n'étudions pas assez d'individus
effectifs_totaux


```

```{r, echo=FALSE, include=FALSE}
effectifs_totaux
#barplot(population ~ effectif_total_region, data = effectifs_totaux)
# ça ne marche pas car on observe plusieurs fois chaque population

```



On sépare les populations humaines et animales pour permettre une meilleure comparaison car les effectifs sont d'ordres différents. 

```{r étude des effectifs de données_AMR, echo=FALSE, include=TRUE}
effectifs_totaux_humain<-effectifs_totaux%>%
  filter(famille==unique(AMR$famille)[2])

ggplot(data=effectifs_totaux_humain, aes(x = annee, y = effectif_total_national)) +
  geom_col(width = 1, fill = "skyblue") +       # tracer le nombre de cas sous forme de colonnes
  theme_minimal()+                              # simplifier les  arrière-plans
  labs(                                         # ajouter  les noms d'axes, titres ... 
    x = "Année d'étude",
    y = "Effectif AMR étudié",
    title = "Effectif total AMR par population humaine en fonction de l'année") +
  facet_wrap(~population) 

effectifs_totaux_animale<-effectifs_totaux%>%
  filter(famille==unique(AMR$famille)[1])

ggplot(data=effectifs_totaux_animale, aes(x = annee, y = effectif_total_national)) +
  geom_col(width = 1, fill = "orange") +       # tracer le nombre de cas sous forme de colonnes
  theme_minimal()+                              # simplifier les  arrière-plans
  labs(                                         # ajouter  les noms d'axes, titres ... 
    x = "Année d'étude",
    y = "Effectif AMR étudié",
    title = "Effectif total AMR par population animale en fonction de l'année") +
  facet_wrap(~population) 

  
```


Observations : 
1. Dans l'étude des populations humaines, pour les ES, les observations commencent seulement à l'année 2019. 
2. En abattoir l'effectif AMR est toujours plus faible, et la résistance aux antibio est testée seulement tous les deux ans. Est ce que c'est plus faible car justement on ne test qu'une petite partie de tous les animaux en abattoir ?



# Etudes des données PROMISE
#### chargement des données, reformattage et filtration (sans SARM)
Les variables qui nous intéressent ici sont : 

* population
* region 
* annee
* profil_AMR
* effectif_AMR
```{r mise en forme des Reseau Resapath, echo=FALSE, include=FALSE}

#LNR

Modele_LNR <- read_xlsx(
  "donnees/Modele_LNR.xlsx",
  sheet = "Modele de collecte", #nom de la page à garder
)
# changement "bovin-abattoir" en "veau-abattoir"
Modele_LNR$population[which(Modele_LNR$population=='bovin-abattoir')]="veau-abattoir"

# reformatage des variables étudiées
Modele_LNR<-Modele_LNR%>%
  mutate(population=as.factor(population),
         region=as.factor(region),
         profil_AMR=as.factor(`profil AMR`),
         )%>%
  rename(effectif_AMR=`effectif AMR`, valeur_AMR=`valeur AMR`)

Modele_LNR_sansSARM<-Modele_LNR%>%
  filter(profil_AMR!="SARM")



# Resapath 1
Resapath1 <- read_xlsx(
  "donnees/ModeleCollecte_PROMISE_Resapath.xlsx",
  sheet = "Modele de collecte", #nom de la page à garder
)
# reformatage des variables étudiées
Resapath1<-Resapath1%>%
  mutate(population=as.factor(population),
         region=as.factor(region),
         profil_AMR=as.factor(`profil AMR`),
         )%>%
  rename(effectif_AMR=`effectif AMR`, valeur_AMR=`valeur AMR`)
Resapath1_sansSARM<-Resapath1%>%
  filter(profil_AMR!="SARM")


# Dindes 

ResapathDindes <- read_xlsx(
  "donnees/ModeleCollecte_PROMISE_ResapathDindes.xlsx",
  sheet = "Modele de collecte", #nom de la page à garder
)
ResapathDindes<-ResapathDindes%>%
  mutate(population=as.factor(population),
         region=as.factor(region),
         profil_AMR=as.factor(`profil AMR`),
         )%>%
  rename(effectif_AMR=`effectif AMR`, valeur_AMR=`valeur AMR`)
levels(ResapathDindes$profil_AMR)

# on retire les observations SARM et cela supprime également les lignes où il n'y a rien
ResapathDindes_sansSARM<-ResapathDindes%>%
  filter(profil_AMR!="SARM")


# En enlevant SARM, on perd 4131 observations ???? NON, c'est juste qu'il y a énormément de lignes complètement vides

#France

ResapathFrance <- read_xlsx(
  "donnees/ModeleCollecte_PROMISE_ResapathFrance.xlsx",
  sheet = "Modele de collecte", #nom de la page à garder
)



# ! La variable region n'est pas renseignée ici puisqu'on traite les données Nationale
ResapathFrance<-ResapathFrance%>%
  mutate(population=as.factor(population),
         profil_AMR=as.factor(`profil AMR`),
         region=as.factor(region)
         )%>%
  rename(effectif_AMR=`effectif AMR`, valeur_AMR=`valeur AMR`)
levels(ResapathFrance$profil_AMR)
# on retire les observations SARM et cela supprime également les lignes où il n'y a rien
ResapathFrance_sansSARM<-ResapathFrance%>%
  filter(profil_AMR!="SARM")


#OviCap

ResapathOviCap <- read_xlsx(
  "donnees/ModeleCollecte_PROMISE_ResapathOviCap.xlsx",
  sheet = "Modele de collecte", #nom de la page à garder
)

ResapathOviCap<-ResapathOviCap%>%
  mutate(population=as.factor(population),
         region=as.factor(region),
         profil_AMR=as.factor(`profil AMR`),
         )%>%
  rename(effectif_AMR=`effectif AMR`, valeur_AMR=`valeur AMR`)

# on retire les observations SARM et cela supprime également les lignes où il n'y a rien
ResapathOviCap_sansSARM<-ResapathOviCap%>%
  filter(profil_AMR!="SARM")


# avant de concaténer les tables, vérifions que les noms de colonnes sont bien les mêmes

#colnames(modele_LNR)==colnames(Resapath1)
#colnames(modele_LNR)==colnames(ResapathDindes)
#colnames(modele_LNR)==colnames(ResapathFrance)
#colnames(modele_LNR)==colnames(ResapathOviCap)




# on ne peut pas effectuer la concaténation car ResapathFrance reprend des informations des autres tables

# à ne surtout pas FAIRE :
# Collecte <-rbind(modele_LNR,Resapath1,ResapathDindes,ResapathFrance,ResapathOviCap)


```

| Réseau | Dispositif |Région | population | bactérie(s) étudiée(s)|Profils AMR |
|:-------:|:-------:|:-------:|:--------:|:------:|:------:|
| Resapath1_sansSARM|`r unique(Resapath1_sansSARM$dispositif)`| `r levels(Resapath1_sansSARM$region)` | `r levels(Resapath1_sansSARM$population)` | `r unique(Resapath1_sansSARM$bacterie)`|`r unique(Resapath1_sansSARM$profil_AMR)` |
| ResapathDindes_sansSARM | `r unique(ResapathDindes_sansSARM$dispositif)`|`r levels(ResapathDindes_sansSARM$region)` | `r levels(ResapathDindes_sansSARM$population)` |`r unique(ResapathDindes_sansSARM$bacterie)`| `r unique(ResapathDindes_sansSARM$profil_AMR)` |
| ResapathFrance_sansSARM |`r unique(ResapathFrance_sansSARM$dispositif)`| `r levels(ResapathFrance_sansSARM$region)` | `r levels(ResapathFrance_sansSARM$population)` |`r unique(ResapathFrance_sansSARM$bacterie)`| `r unique(ResapathFrance_sansSARM$profil_AMR)` | 
| ResapathOviCap_sansSARM |`r unique(ResapathOviCap_sansSARM$dispositif)`|`r levels(ResapathOviCap_sansSARM$region)` | `r levels(ResapathOviCap_sansSARM$population)` | `r unique(ResapathOviCap_sansSARM$bacterie)`|`r unique(ResapathOviCap_sansSARM$profil_AMR)` | 
| Modele_LNR_sansSARM |`r unique(Modele_LNR_sansSARM$dispositif)`| `r levels(Modele_LNR_sansSARM$region)` | `r levels(Modele_LNR_sansSARM$population)` | `r unique(Modele_LNR_sansSARM$bacterie)`|`r unique(Modele_LNR_sansSARM$profil_AMR)` | 



On remarque que les données se superposent car plusieurs régions. Les régions concernées étant `unique(Collecte$region)`
Comment faire ? Peut-être faire une moyenne des effectifs par région en groupant par année ?


#### Comment est-ce possible que la population des lapins soit si grande ? 
études des observations de la variable region 
La table Collecte est formées des données issues des tables : 
* donnes_AMR
* Resapath
* ResapathDindes
* ResapathFrance
* ResapathOviCap

L'erreur est tout à fait logique puisque les données sont doublées ...
Dans le réseau `ResapathFrance`, on étudie les populations suivantes : 
`levels(ResapathFrance$population)`
En revanche, pourquoi on a une autre table `ResapathDindes` ?


## Modèle LNR
```{r, echo=FALSE, include=TRUE}
#Collecte_grouped<-Collecte%>%
#  group_by(annee,`profil AMR`,population)%>%
#  summarise(`effectif AMR`=mean(`effectif AMR`))

#Modification de la fonction pour prendre en compte le calcul moyen de l'effectif (groupement par année donc effectif moyen des région)
etude_effectifmoy_profil<-function(modele,pop){
mod_effmoy_profil<-modele%>%
  filter(population==pop)
plot<-ggplot(data=mod_effmoy_profil, aes(x =profil_AMR, y = effectif_AMR),ylim=c(0,1000)) +
  geom_col(width = 1, aes(fill =profil_AMR)) +       # tracer le nombre de cas sous forme de colonnes
  theme_minimal()+                              # simplifier les  arrière-plans
  labs(                                         # ajouter  les noms d'axes, titres ... 
    x = "Profil AMR ",
    y = "Effectif AMR moyen (par région) étudié",
    title = str_glue("Effectif AMR moyen par profil AMR de la population : {pop} \n en fonction de l'année étudiée")) +
  facet_wrap(~annee)+
  scale_x_discrete(labels=NULL, breaks=NULL)
return(plot)
}

pop<-"veau"

for (pop in levels(Modele_LNR_sansSARM$population)){
  plot(etude_effectifmoy_profil(Modele_LNR_sansSARM,pop))
  }


```


Analyse par population 


Hormis pour le bovin-abattoir à l'année 2019, dans ce cas le profil FQ-R semble être plus sensible que les autres (effectif plus grand), aucun antibiotique ne semble présenter une résistance plus forte ce qui aurait engendrer une grosse différence dans les effectifs. 
Il n'y a donc pas de grande perte d'effectif suite aux AB testés. 

étude sur les régions `unique(modele_LNR$region)`seulement et les populations `unique(modele_LNR$population)`

Question : Pourquoi la pan-sensibilité présente un effectif plus grand alors que le test est censé être validé par tous les tests avant ? Je m'attendais à obtenir un effectif au plus à même hauteur que l'effectif le plus faible parmi les antibiotiques testés.  



# Etude de la contribution des variables à la variance
```{r, echo=FALSE, include=FALSE}

AMR_modele<-AMR%>%
  select(annee,famille,population,region,`valeur AMR`)%>%
  rename(valeur_AMR=`valeur AMR`)
AMR_modele_humain<-AMR_modele%>%
  filter(famille=="humaine",region!="Nationale")
AMR_modele_animale<-AMR_modele%>%
  filter(famille=="animale",region!="Nationale")
# On décide de retirer l'observation Nationale car, incluant l'ensemble des régions et +, elle contribuerait trop à la valeur AMR

data=AMR_modele_humain
modele_H <- lm(valeur_AMR~ annee + population + region, data = AMR_modele_humain,na.action = na.exclude)

summary(modele_H)
# Extraire les coefficients de régression
coefficients <- coef(modele_H)

# Calculer les contributions à la variance
variance_contributions= round((coefficients^2 / var(data$valeur_AMR))*100,2)
print(variance_contributions)
```













# CARTE
```{r, echo=FALSE, include=FALSE}

```

Carte.1 Recupération des régions
```{r, echo=FALSE, include=FALSE}
unique(AMR$region)
```

Carte.2 Chargement des données issues de l'INSEE pour associer la carte
```{r, echo=FALSE, include=FALSE}
library(readr)
region2019 <- read_csv("donnees/region2019.csv")
```


8.3 Récupérons les données humaine / ES de 2012

```{r, echo=FALSE, include=FALSE}
library(dplyr)
ES_2012<-AMR%>%
  filter(annee==2012 & famille=='humaine')%>%
  select(region,`valeur AMR`,population)%>%
  arrange(region)
  
# Remarque : toutes les années ne sont pas renseignées pour toutes les population humaine
```



9. Chargement des données en vrac

```{r, echo=FALSE, include=FALSE}
library(readr)
library(readxl)

# Les régions 

regions <- read_csv("donnees/region2019.csv")

# données par régions 
part_classe_age <- read_excel("donnees/série Insee part des classes d'age dans population.xlsx")


#donnees AMR
Classeur4 <- read_excel("donnees/Classeur4.xlsx")
D_animale_nationale_avec_alea_corrige <- read_excel("donnees/D_animale_nationale_avec_alea_corrige.xlsx")

```





